name: Dependency Management and Vulnerability Scanning

on:
  # Trigger this workflow on a push to the main branch and for pull requests
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  
  schedule:
    - cron: "0 0 * * 0"  # Weekly schedule for automated security checks

jobs:
  bandit_sast:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
    
    - name: Scan with Bandit (SAST)
      uses: shundor/bandit-action@v1
      with: 
        path: "."
        level: high
        confidence: high
        exit_zero: true

  trufflehog_scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout Code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        ref: ${{ github.head_ref }}  # Necessary for pull request workflow trigger
    
    - name: Run TruffleHog Scan for Secrets
      uses: edplato/trufflehog-actions-scan@master
      continue-on-error: false

    - name: Check TruffleHog Scan Results
      if: ${{ steps.trufflehog.outcome == 'failure' }}
      run: exit 1

  snyk_scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
    
    - name: Run Snyk to Check for Vulnerabilities
      uses: snyk/actions/python@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
